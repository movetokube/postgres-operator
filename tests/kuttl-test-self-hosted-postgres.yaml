apiVersion: kuttl.dev/v1beta1
kind: TestSuite
testDirs:
  - ./tests/e2e/
# crdDir: ./deploy/crds/
startKIND: true
kindContext: self-hosted-postgres
kindContainers:
  - postgres-operator:build
artifactsDir: ./tests/
commands:
  - command: >-
      helm install -n $NAMESPACE postgresql oci://registry-1.docker.io/bitnamicharts/postgresql
      --set global.postgresql.auth.password=postgres
      --set global.postgresql.auth.username=postgres
      --wait
    timeout: 120
  - command: >-
      kubectl -n $NAMESPACE exec postgresql-0 -- bash -lc
      "export PGPASSWORD=postgres;
      psql -U postgres -d postgres -v ON_ERROR_STOP=1 -c \"
      DO \\$\\$
      BEGIN
        IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = 'pgoperator') THEN
          CREATE ROLE pgoperator WITH PASSWORD 'pgoperator' LOGIN CREATEDB CREATEROLE;
        END IF;
      END
      \\$\\$;\""
    timeout: 10
  - command: >-
      helm install -n $NAMESPACE ext-postgres-operator ./charts/ext-postgres-operator
      --set image.repository=postgres-operator
      --set image.tag=build
      --set postgres.host=postgresql
      --set postgres.user=pgoperator
      --set postgres.password=pgoperator
      --set postgres.uri_args="sslmode=disable"
      --wait
